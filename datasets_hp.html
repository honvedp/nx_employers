<!doctype html>
<html>
<head>
    <title>Network | Dynamic Data</title>

<!--    <script type="text/javascript" src="lib/vis.js"></script> -->
	<script src="data/eventsData.js" ></script> 
	<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.min.js"></script>
    <script src="lib/jQDateRangeSlider-min.js"></script>
    <script src="./lib/vis-network.min.js" type="text/javascript"></script>
	
	<link rel="stylesheet" href="./lib/vis-network.min.css" type="text/css" />
    <link rel="stylesheet" href="lib/css/font-awesome.min.css"> 
    <link rel="stylesheet" href="lib/css/iThing.css" type="text/css" />
	

    <style type="text/css">
        body {
			color: #90A4AE;
            font: 10pt arial;
            background-color: #4B4B4B;
        }	
		
        #mynetwork {
		    height: 500px;
        }
        h4 {
            margin-bottom:3px;
        }
	
    </style>
</head>

<div id="dateSlider"></div>
<div id="mynetwork"></div>

<script type="text/javascript">

	$(document).ready(function(){
		$("#mynetwork").height((parseInt($(document).height()-100)));
	}); 
	
	
    $("#dateSlider").dateRangeSlider();
	

	$("#dateSlider").dateRangeSlider("bounds", new Date(2018, 0, 1), new Date(2018, 11, 30));
	$("#dateSlider").dateRangeSlider("values", new Date(2018, 1, 1), new Date(2018, 10, 30));


	$("#dateSlider").bind("userValuesChanged", function(e, data){
		console.log("Values just changed. min: " + data.values.min.toISOString().substring(1, 19) + " max: " + data.values.max.toISOString().substring(1, 19));
	});
    


	var gDebug = true;
	var gEmployer = 0;
	var actEventDT;
	var nodeIds = [];
	var edgeIds = [];
	var actNodes = [];
	
    var /*shadowState, */nodes, edges, network;
//	var snapshotDs = new vis.DataSet();
            edges = new vis.DataSet();
	

	var startDate = new Date('2017-11-08T00:00:00Z');
	var endDate = new Date('2017-11-08T24:00:00Z');
	
    createNetwork(); // gráf létrehozása
	loadData();
	

	function loadData() {
		myLog("loadData - START");	

		for (i = 0; i < employersD.length; i++ ) {
			
			// eventsD végigolvasása, amíg stimmel a dátum
//			for (i = gEvent; i < 13 && eventsD[i].eventDT == snapshotEventDT; i++) { 
/*					upsertNode('un_' + eventsD[i].userName, eventsD[i].userName, 'dot', 'user', snapshotEventDT);
					upsertNode('on_' + eventsD[i].objectName, eventsD[i].objectName, 'dot', 'object', snapshotEventDT);
				
					upsertEdge('un_' + eventsD[i].userName, 'on_' + eventsD[i].objectName);*/

					upsertNode(employersD[i].id, employersD[i].name, employersD[i].name + '</br>(' + employersD[i].email + ')', 'dot', 'user');

				gEmployer ++;
				myLog('eventsD végigolvasása: ' + employersD[i].name);
//			}
		}
		
		for (i = 0; i < projektsD.length; i++ ) {
			// projektsD végigolvasása, amíg stimmel a dátum
//			for (i = gEvent; i < 13 && eventsD[i].eventDT == snapshotEventDT; i++) { 

					upsertNode(projektsD[i].code, projektsD[i].code, projektsD[i].name, 'dot', 'project');
					upsertEdge(projektsD[i].code, projektsD[i].managerID);

				gEmployer ++;
				myLog('projektsD végigolvasása: ' + projektsD[i].code);
//			}
		}
		for (i = 0; i < allocationsD.length; i++ ) {
			// allocationsD végigolvasása, amíg stimmel a dátum
//			for (i = gEvent; i < 13 && eventsD[i].eventDT == snapshotEventDT; i++) { 

					upsertEdge(allocationsD[i].projectCodeFrom, allocationsD[i].userIdTo);

				myLog('allocationsD végigolvasása: ' + allocationsD[i].projectCodeFrom + ' -> ' + allocationsD[i].userIdTo);
//			}
		}		
		for (i = 0; i < conversationsD.length; i++ ) {
			// conversationsD végigolvasása, amíg stimmel a dátum
//			for (i = gEvent; i < 13 && eventsD[i].eventDT == snapshotEventDT; i++) { 

					upsertEdge(conversationsD[i].userIdFrom, conversationsD[i].userIdTo);

				myLog('conversationsD végigolvasása: ' + conversationsD[i].userIdFrom + ' -> ' + conversationsD[i].userIdTo);
//			}
		}
	
		// snapshotDs töltése*/
//		snapshotDs.update([{id: snapshotsD[gKor].eventDT, nodes: actNodes.map(x=>x)}]);
      network.fit();
		
	  myLog("loadData - END");	
		
	}

/*	function unsetNodes() {
		for (i = 0; i < actNodes.length; i++) { 
			nodes.update([{id: actNodes[i], group: nodes.get(actNodes[i]).group.substring(3) }]);
		}
		actNodes.length = 0;
	}
	*/
	function upsertNode(pId, pLabel, pTitle, pShape, pGroup){
		if (actNodes.indexOf( pId) < 0){
			actNodes.push(pId);
		};
		
		if (  nodeIds.indexOf( pId) >= 0) {
			var actNode = nodes.get(pId);
		    var pSize = actNode.size + 10;
			if (actNode.group.substring(0, 3) == 'act'){
				nodes.update([{id: pId, size: pSize, icon: {size: pSize}, group: actNode.group}]);
			} else {
				nodes.update([{id: pId, size: pSize, icon: {size: pSize}, group: 'act'+ actNode.group }]);
			}
//			actNode.events.push(snapshotEventDT);
		} else {
			nodes.add({id: pId, /*label: pLabel, */title: pTitle, label: pLabel, shape: pShape, size: 15, icon: {size: 15}, group: 'act'+pGroup/*, events: [snapshotEventDT]*/});
//			nodes.add({id: pId, /*label: pLabel, */title: pLabel, shape: pShape, size: 15, icon: {size: 15}, group: 'user'/*, events: [snapshotEventDT]*/});
			nodeIds.push(pId);
		}
	}

	function upsertEdge(pFrom, pTo){
		var lId = pFrom + ' -> ' + pTo;
		if (  edgeIds.indexOf( lId) >= 0) {
			edges.update([{id: lId, width: edges.get(pFrom + ' -> ' + pTo).width + 1 }]);
		} else {
			edges.add({id: lId, from: pFrom, to: pTo, width: 1});
			edgeIds.push(lId);
		}
	
	}

    function createNetwork() {
        nodes = new vis.DataSet();
        edges = new vis.DataSet();

        // create a network
        var containerN = document.getElementById('mynetwork');
        var data = {
            nodes: nodes,
            edges: edges
        };
        var options = {
			height: '100%',
			width: '100%',
			interaction:{hover:true},
			groups: {
				userGroup: {
					shape: 'icon',
					color: 'gray',
					icon: {
						face: 'FontAwesome',
						code: '\uf0c0',
						color: 'gray',
						}
				},
				actuserGroup: {
					shape: 'icon',
					color: 'rgb(83,186,242)',
					icon: {
						face: 'FontAwesome',
						code: '\uf0c0',
						color: 'rgb(83,186,242)'
						}
				},
				objectOwner: {
					shape: 'icon',
					color: 'gray',
					icon: {
						face: 'FontAwesome',
						code: '\uf0e8',
						color: 'gray'
						}
				},
				actobjectOwner: {
					shape: 'icon',
					color: 'rgb(83,186,242)',
					icon: {
						face: 'FontAwesome',
						code: '\uf0e8',
						color: 'rgb(83,186,242)'
						}
				},
				user: {
					shape: 'icon',
					color: 'gray',
					icon: {
						face: 'FontAwesome',
						code: '\uf007',
//						size: 224,
						color: 'gray'
						}
				},
				actuser: {
					shape: 'icon',
					color: 'rgb(101,200,192)', // vonal - Petrol light
					icon: {
						face: 'FontAwesome',
						code: '\uf007',
						class: 'fa-circle',
						color: 'rgb(33,128,118)' // csomópont - Petrol dark
						}
				},
				project: {
					shape: 'icon',
					color: 'gray',
					icon: {
						face: 'FontAwesome',
						code: '\uf15c',
						color: 'gray'
						}
				},
				actproject: {
					shape: 'icon',
					color: 'rgb(126,203,245)',	// vonal - Blue light
					icon: {
						face: 'FontAwesome',
						code: '\uf15c',
						color: 'rgb(49,124,179)' // csomópont - Light blue dark
						}
				},
				object: {
					shape: 'icon',
					color: 'gray',
					icon: {
						face: 'FontAwesome',
						code: '\uf0ce',
						color: 'gray'
						}
				},
				actobject: {
					shape: 'icon',
					color: 'rgb(126,203,245)',	// vonal - Blue light
					icon: {
						face: 'FontAwesome',
						code: '\uf0ce',
						color: 'rgb(49,124,179)' // csomópont - Light blue dark
						}
				},
				
			}
		};
        network = new vis.Network(containerN, data, options);
    }
	
	// debug 
	function myLog(logText){
		if (gDebug == true) {
			console.log(logText);	
		}
	}
	
    function changeOptions() {
        shadowState = !shadowState;
        network.setOptions({nodes:{shadow:shadowState},edges:{shadow:shadowState}});
    }


</script>


</body>
</html>
